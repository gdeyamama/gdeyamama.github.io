<!DOCTYPE html>
<html>
	<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>Где я, мама?</title>
		<link rel="manifest" href="manifest.json">

		<link rel="stylesheet" href="libs/leaflet/leaflet.css">
		<link rel="stylesheet" href="styles.css">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body>
    <header id="header">
    </header>
		<main>
			<div id="map"></div>
			<button class="button-action" id="fab">
				<svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" width="1rem" height="1rem"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4m8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7" fill="currentColor"></path></svg>
			</button>

		</main>
		<footer id="footer">
      <svg viewBox="0 0 200 100" height="100" xmlns="http://www.w3.org/2000/svg" id="svg">
        <polyline  stroke-linecap="round" stroke-linejoin="round" points="" fill="none" stroke="red" id="plln"/>
        <line x1="0" y1="0" x2="0" y2="0"  id="topline" />
        <line x1="0" y1="0" x2="0" y2="0"  id="midline" />
        <line x1="0" y1="0" x2="0" y2="0"  id="bottomline" />
        <text x="0" y="0"  id="toplineText" ></text>
        <text x="0" y="0"  id="midlineText" ></text>
        <text x="0" y="0"  id="bottomlineText" ></text>
      </svg>
    </footer>
		<script src="libs/leaflet/leaflet.js"></script>
    <script src="utils.js"></script>

    <script>
      if ('serviceWorker' in navigator) {
          window.addEventListener("load", () => {
              navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                  console.log('ServiceWorker registered');
                }).catch(function(err) {
                  console.log('ServiceWorker error: ', err);
                });
          })
      }
    </script>
    <dialog id="demoDialog">
      <input type="time" id="demodate" />
    </dialog>

    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
      import { getDatabase, ref, set, child, get, push, increment, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js'

      const firebaseConfig = {
        apiKey: "AIzaSyCo7VJ_rskVkgvi6gSUEj3A2cegIG4D0Rc",
        authDomain: "gdeyamama-41094.firebaseapp.com",
        projectId: "gdeyamama-41094",
        storageBucket: "gdeyamama-41094.appspot.com",
        messagingSenderId: "462554712065",
        appId: "1:462554712065:web:cf4a4c318c34b38b851800",
        databaseURL: "https://gdeyamama-41094-default-rtdb.europe-west1.firebasedatabase.app",
      };
    
      // Initialize Firebase
      const app = await initializeApp(firebaseConfig);
        
      const database = getDatabase(app);
        
      const auth = getAuth(app);

      //console.log('auth.currentUser', auth.currentUser)

      window.db = {
        set: async (path, data) => {
          return await set(ref(database, path), data);
        },
        get: async (path) => {
          const snapshot = await get(child(ref(database), path));
          if (snapshot.exists()) {
            return snapshot.val()
          }

          return null;
        },
        update: async (pathValueMap) => {
          return update(ref(database), pathValueMap);
        },
        getUniqueKey: async (path) => {
          return await push(child(ref(database), path)).key
        },

        addListener: (path, cb) => {
          const r = ref(database, path);
          onValue(r, (snapshot) => {
            const data = snapshot.val();
            cb(data);
          });
        },
        removeListener: (path) => {

        },
        
      }
       
      window.auth = {
        user: null,
        login: () => {
          setPersistence(auth, browserLocalPersistence).then(() => {
            const provider = new GoogleAuthProvider();
            return signInWithPopup(auth,provider);
          })
        },
        logout: () => {
          signOut(auth);
        },
        loginListeners: [],
        logoutListeners: []
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.auth.user = user;
          window.db.set(`users/${user.uid}`, { name: user.displayName, photo: user.photoURL, email: user.email, lastLogin: new Date().toISOString() })
          window.auth.loginListeners.forEach((cb) => cb.call(cb, user))
        } else {
          window.auth.user = null;
          console.log('onAuthStateChanged NO', user);
          window.auth.logoutListeners.forEach((cb) => cb.call(cb))
        }
      });
    </script>
		<script src="scripts.js"></script>
	</body>
</html>
